{% extends 'appcomment/base.html' %}

{% block title %}Mail List{% endblock %}

{% block content %}
    <form method="POST">
        {% csrf_token %}
        {{ diary_form.as_p }}
        <input type="hidden" name="form-type" value="diary">
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    {% if diary_app %}
        {% for entry in diary_app %}
            <div class = 'diary-container' id = 'diary-id-'+{{entry.id}}>
                <hr>
                <p><strong>{{ entry.user }}</strong> ‚Äî {{ entry.created_at }}</p>
                <p><strong>{{ entry.title }}</strong>: {{ entry.body }} <span class = 'like-btn' data-diary-id = {{entry.id}}>‚ù§Ô∏è</span></p>

                {% if entry.user == request.user %}
                    <a href="{% url 'update' entry.id %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="{% url 'delete' entry.id %}">–£–¥–∞–ª–∏—Ç—å</a>
                {% endif %}

                <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã -->
                <a href="#" onclick="toggleForm({{ entry.id }}); return false;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</a>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
            {% for comm in comment_app %}
                <div class = 'comment-container' id ='comment-id-' + {{comm.id}}>
                    {% if comm.diary_entry.id == entry.id %}
                        <p style="margin-left: 20px;">üó®Ô∏è <strong>{{ comm.user }}</strong> ‚Äî {{ comm.created_at }}<br>
                        {{ comm.text }}</p>
                    {% endif %}
                </div>
            {% endfor %}

            <!-- –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞) -->
            <form id="comment-form-{{ entry.id }}" class="comment-form" method="POST" action="{% url 'add_comment' entry.id %}" style="display: none;">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <input type = 'hidden' name = 'diary_entry' value = {{entry.id}}>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
        {% endfor %}
    {% else %}
        <h2>–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏</h2>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    function toggleForm(entry_id){
        const form = document.getElementById('comment-form-' + entry_id);
        if(form){
            form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const commentId = this.dataset.commentId;

            fetch('/like-comment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ comment_id: commentId })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById(`like-count-${commentId}`).textContent = data.likes_count;
            });
        });
    });
    });

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ —Ç—ã –µ—ë –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // –ù–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –∫—É–∫—É
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
</script>
{% endblock %}

